{% extends "base.html" %}
{% block content %}
  <!-- Add a row for the Data Sync button and label -->
  <div class="flex items-center mb-4">
    <button id="dataSyncButton"
            class="bg-blue-500 text-white px-4 py-2 rounded mr-4">{{ _('data_sync') }}</button>
    <span id="lastSyncLabel" class="text-gray-600">{{ _('last_sync') }}</span>
    <div id="loadingIndicator" class="ml-4 hidden">{{ _('loading') }}</div>
    <!-- 로딩 표시 -->
  </div>
  <h2 class="text-lg font-semibold mt-4 mb-3">{{ _('dashboard') }}</h2>
  <!-- KPI cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white shadow rounded p-4">
      <div class="text-lg text-gray-600 mb-1">USD → KRW</div>
      <div id="rate" class="text-4xl font-semibold">--</div>
      <div id="rate_asof" class="text-lg text-gray-600 mt-1"></div>
    </div>
    <!-- 총 자산 -->
    <div class="bg-white shadow rounded p-4">
      <div class="text-lg text-gray-600 mb-1">{{ _('total_assets') }}</div>
      <div class="text-2xl font-semibold" id="total_both">--</div>
    </div>
    <!-- 자산 in USD -->
    <div class="bg-white shadow rounded p-4">
      <div class="text-lg text-gray-600 mb-1">{{ _('assets_usd') }}</div>
      <div class="text-2xl font-semibold" id="total_usd">--</div>
      <div class="text-lg text-gray-600 mt-1" id="usd_percent"></div>
    </div>
    <!-- 자산 in KRW -->
    <div class="bg-white shadow rounded p-4">
      <div class="text-lg text-gray-600 mb-1">{{ _('assets_krw') }}</div>
      <div class="text-2xl font-semibold" id="total_krw">--</div>
      <div class="text-lg text-gray-600 mt-1" id="krw_percent"></div>
    </div>
  </div>
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="text-sm font-medium mb-2">{{ _('usd_accounts') }}</div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">{{ _('bank') }}</th>
            <th class="p-2 text-left">{{ _('account_name') }}</th>
            <th class="p-2 text-right border-r-2">{{ _('balance_usd') }}</th>
            <th class="p-2 text-right bg-blue-50">{{ _('cash') }}</th>
            <th class="p-2 text-right bg-blue-50">{{ _('saving') }}</th>
            <th class="p-2 text-right bg-blue-50">{{ _('bond') }}</th>
            <th class="p-2 text-right bg-blue-50 border-r-2 border-gray-300">{{ _('stock') }}</th>
            <th class="p-2 text-right border-r-2">{{ _('converted_krw') }}</th>
            <th class="p-2 text-right bg-yellow-50">{{ _('invested_amount_usd') }}</th>
            <th class="p-2 text-right bg-yellow-50">{{ _('profit_amount_usd') }}</th>
            <th class="p-2 text-right bg-yellow-50 border-r-2 border-gray-300">{{ _('return_rate') }}</th>
            <th class="p-2 text-right">
              {{ _('fx_effect') }}
              <br>
              <span class="text-xs text-gray-500">{{ _('avg_rate') }}</span>
            </th>
            <th class="p-2 text-right">{{ _('fx_considered_profit_krw') }}</th>
            <th class="p-2 text-right">{{ _('fx_considered_return_rate') }}</th>
          </tr>
        </thead>
        <tbody id="usd_table">
        </tbody>
        <tfoot class="bg-gray-100 font-semibold">
          <tr>
            <td colspan="2" class="p-2 text-right">{{ _('total') }}</td>
            <td class="p-2 text-right" id="usd_sum_usd"></td>
            <td class="p-2 text-right" id="usd_sum_cash"></td>
            <td class="p-2 text-right" id="usd_sum_saving"></td>
            <td class="p-2 text-right" id="usd_sum_bond"></td>
            <td class="p-2 text-right" id="usd_sum_stock"></td>
            <td class="p-2 text-right" id="usd_sum_krw"></td>
            <td class="p-2 text-right" id="usd_sum_invested_usd"></td>
            <td class="p-2 text-right" id="usd_sum_return_amt"></td>
            <td class="p-2 text-right" id="usd_sum_return_pct"></td>
            <td class="p-2 text-right" id="usd_sum_fx_effect_pct">-</td>
            <td class="p-2 text-right" id="usd_sum_fx_return_amt">!</td>
            <td class="p-2 text-right" id="usd_sum_fx_return_pct">!</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <!-- KRW 계좌 목록 -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="text-sm font-medium mb-2">{{ _('krw_accounts') }}</div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">{{ _('bank') }}</th>
            <th class="p-2 text-left">{{ _('account_name') }}</th>
            <th class="p-2 text-right border-r-2">{{ _('balance_krw') }}</th>
            <!-- Breakdown 컬럼 -->
            <th class="p-2 text-right bg-blue-50">{{ _('cash') }}</th>
            <th class="p-2 text-right bg-blue-50">{{ _('saving') }}</th>
            <th class="p-2 text-right bg-blue-50">{{ _('bond') }}</th>
            <th class="p-2 text-right bg-blue-50 border-r-2">{{ _('stock') }}</th>
            <th class="p-2 text-right border-r-2">{{ _('converted_usd') }}</th>
            <!-- 수익 관련 컬럼 -->
            <th class="p-2 text-right bg-yellow-50">{{ _('invested_amount_krw') }}</th>
            <th class="p-2 text-right bg-yellow-50">{{ _('profit_amount_krw') }}</th>
            <th class="p-2 text-right bg-yellow-50 border-r-2">{{ _('return_rate') }}</th>
          </tr>
        </thead>
        <tbody id="krw_table">
        </tbody>
        <tfoot class="bg-gray-100 font-semibold">
          <tr>
            <td colspan="2" class="p-2 text-right">{{ _('total') }}</td>
            <td class="p-2 text-right" id="krw_sum_krw"></td>
            <td class="p-2 text-right" id="krw_sum_cash"></td>
            <td class="p-2 text-right" id="krw_sum_saving"></td>
            <td class="p-2 text-right" id="krw_sum_bond"></td>
            <td class="p-2 text-right" id="krw_sum_stock"></td>
            <td class="p-2 text-right" id="krw_sum_usd"></td>
            <td class="p-2 text-right" id="krw_sum_invested_krw"></td>
            <td class="p-2 text-right" id="krw_sum_return_amt"></td>
            <td class="p-2 text-right" id="krw_sum_return_pct"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <!-- 보유 종목 상세 -->
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="text-sm font-medium mb-2">{{ _('stock_details_usd') }}</div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">{{ _('stock_name') }}</th>
            <th class="p-2 text-left">{{ _('stock_code') }}</th>
            <th class="p-2 text-left">{{ _('account_name') }}</th>
            <th class="p-2 text-right">{{ _('quantity') }}</th>
            <th class="p-2 text-right">{{ _('avg_price_usd') }}</th>
            <th class="p-2 text-right">{{ _('current_price_usd') }}</th>
            <th class="p-2 text-right">{{ _('total_value_usd') }}</th>
            <th class="p-2 text-right">{{ _('total_gain_usd') }}</th>
            <th class="p-2 text-right">{{ _('total_dividend_usd') }}</th>
            <th class="p-2 text-right">{{ _('return_rate') }}</th>
          </tr>
        </thead>
        <tbody id="stock_table_usd">
          <!-- JS에서 동적으로 채움 -->
        </tbody>
      </table>
    </div>
  </div>
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="text-sm font-medium mb-2">{{ _('stock_details_krw') }}</div>
    <div class="overflow-x-auto">
      <table class="table-auto w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-2 text-left">{{ _('stock_name') }}</th>
            <th class="p-2 text-left">{{ _('stock_code') }}</th>
            <th class="p-2 text-left">{{ _('account_name') }}</th>
            <th class="p-2 text-right">{{ _('quantity') }}</th>
            <th class="p-2 text-right">{{ _('avg_price_krw') }}</th>
            <th class="p-2 text-right">{{ _('current_price_krw') }}</th>
            <th class="p-2 text-right">{{ _('total_value_krw') }}</th>
            <th class="p-2 text-right">{{ _('total_gain_krw') }}</th>
            <th class="p-2 text-right">{{ _('total_dividend_krw') }}</th>
            <th class="p-2 text-right">{{ _('return_rate') }}</th>
          </tr>
        </thead>
        <tbody id="stock_table_krw">
          <!-- JS에서 동적으로 채움 -->
        </tbody>
      </table>
    </div>
  </div>
  <div class="bg-white shadow rounded p-4 mb-6">
    <div class="text-sm font-medium mb-2">{{ _('asset_category_breakdown') }}</div>
    <canvas id="categoryPie" class="max-w-[400px] max-h-[400px]"></canvas>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script>
async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(url); return r.json(); }
function fmtUSD(v){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(v); }
function fmtKRW(v){ return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v); }
function num(v){ return typeof v==='number'?v:parseFloat(v||0); }

let currencyPie, allocationPie;

async function load() {
  // 1) 자산 + 환율 데이터
  const s = await getJSON('/api/dashboard');
  // expected:
  // {
  //   rate: number,
  //   as_of: string,
  //   total: { amount_usd: number, amount_krw: number },
  //   breakdown: {
  //     usd_assets: { amount_usd: number, amount_krw: number, percent: number },
  //     krw_assets: { amount_usd: number, amount_krw: number, percent: number }
  //   }
  // }

  // 환율
  document.getElementById('rate').textContent = s.rate?.toLocaleString('ko-KR');
  document.getElementById('rate_asof').textContent = s.as_of ? `${s.as_of}` : '';

  // 총 자산 (USD / KRW 함께 표시)
  document.getElementById('total_both').innerHTML =
    `${fmtUSD(num(s.total.amount_usd))}<br>${fmtKRW(num(s.total.amount_krw))}`;

  // USD 자산
  document.getElementById('total_usd').innerHTML = 
    `${fmtUSD(num(s.breakdown.usd_assets.amount_usd))}<br>${fmtKRW(num(s.breakdown.usd_assets.amount_krw))}`;
  document.getElementById('usd_percent').textContent =
    `(${num(s.breakdown.usd_assets.percent).toFixed(1)}%)`;

  // KRW 자산
  document.getElementById('total_krw').innerHTML = 
    `${fmtUSD(num(s.breakdown.krw_assets.amount_usd))}<br>${fmtKRW(num(s.breakdown.krw_assets.amount_krw))}`;
  
  document.getElementById('krw_percent').textContent =
    `(${num(s.breakdown.krw_assets.percent).toFixed(1)}%)`;

  // --- USD 계좌 렌더링 ---
  const usd_tbody = document.getElementById('usd_table');
  let usd_total_usd = 0, usd_total_krw = 0;
  let usd_total_cash = 0, usd_total_saving = 0, usd_total_bond = 0, usd_total_stock = 0;
  let usd_total_invested = 0, usd_total_profit = 0;
  let total_krw_net = 0;
  let total_usd_net = 0;
  let total_investment = 0;

  const order = { Stock: 0, Saving: 1, Checking: 2 };

  const usd_sorted = s.usd_accounts.map((acc, idx) => {
    return {
      ...acc,
      networth_usd: num(s.usd_networths[idx]),
      networth_krw: num(s.usd_networths[idx]) * s.rate
    };
  }).sort((a, b) => {
    // 1) account_type 우선순위 비교
    if (order[a.account_type] !== order[b.account_type]) {
      return order[a.account_type] - order[b.account_type];
    }
    // 2) 같은 카테고리라면 networth_usd 내림차순
    return b.networth_usd - a.networth_usd;
  });

  usd_tbody.innerHTML = usd_sorted.map(acc => {
    const invested = num(acc.breakdown?.invested);
    const profit = num(acc.breakdown?.profit);
    const return_pct = invested ? (profit / invested * 100).toFixed(1) : '0.0';

    usd_total_usd += acc.networth_usd;
    usd_total_krw += acc.networth_krw;
    usd_total_cash += num(acc.breakdown?.cash);
    usd_total_saving += num(acc.breakdown?.saving);
    usd_total_bond += num(acc.breakdown?.bond);
    usd_total_stock += num(acc.breakdown?.stock);
    usd_total_invested += invested;
    usd_total_profit += profit;
    total_krw_net += acc.krw_net;
    total_usd_net += acc.usd_net;

    let fx_effect_html = "-";
    let fx_return_amt_html = "-";
    let fx_return_pct_html = "-";

    if (acc.krw_net > 0 && acc.usd_net > 0) {
      const avg_fx = acc.krw_net / acc.usd_net;
      const fx_only_effect_pct = ((s.rate - avg_fx) / avg_fx) * 100;
      fx_effect_html = `${fx_only_effect_pct.toFixed(2)}%<br><span class="text-xs text-gray-500">(${avg_fx.toFixed(2)})</span>`;

      total_investment += acc.networth_usd
      fx_return_amt_html = fmtKRW(acc.networth_usd * s.rate - acc.krw_net);
      const fx_return_pct = (acc.networth_usd * s.rate - acc.krw_net) / acc.krw_net * 100
      fx_return_pct_html = `${fx_return_pct.toFixed(1)}%`;
    }

    let borderClass = '';
    switch (acc.account_type) {
      case 'Checking':
        borderClass = '';
        break;
      case 'Saving':
        borderClass = 'border-l-4 border-yellow-400';
        break;
      case 'Stock':
        borderClass = 'border-l-4 border-blue-400';
        break;
    }

    return `
      <tr class="border-t">
        <td class="p-2 ${borderClass}">${acc.bank_name}</td>
        <td class="p-2">${acc.account_name}</td>
        <td class="p-2 text-right border-r-2">${fmtUSD(acc.networth_usd)}</td>

        <td class="p-2 text-right bg-blue-50">${fmtUSD(num(acc.breakdown?.cash))}</td>
        <td class="p-2 text-right bg-blue-50">${fmtUSD(num(acc.breakdown?.saving))}</td>
        <td class="p-2 text-right bg-blue-50">${fmtUSD(num(acc.breakdown?.bond))}</td>
        <td class="p-2 text-right bg-blue-50 border-r-2 border-gray-300">${fmtUSD(num(acc.breakdown?.stock))}</td>

        <td class="p-2 text-right border-r-2">${fmtKRW(acc.networth_krw)}</td>

        <td class="p-2 text-right bg-yellow-50">${fmtUSD(invested)}</td>
        <td class="p-2 text-right bg-yellow-50">${fmtUSD(profit)}</td>
        <td class="p-2 text-right bg-yellow-50 border-r-2 border-gray-300">${return_pct}%</td>

        <td class="p-2 text-right">${fx_effect_html}</td>
        <td class="p-2 text-right">${fx_return_amt_html}</td>
        <td class="p-2 text-right">${fx_return_pct_html}</td>
      </tr>`;
  }).join('');

  // 총계 렌더링
  document.getElementById('usd_sum_usd').textContent = fmtUSD(usd_total_usd);
  document.getElementById('usd_sum_cash').textContent = fmtUSD(usd_total_cash);
  document.getElementById('usd_sum_saving').textContent = fmtUSD(usd_total_saving);
  document.getElementById('usd_sum_bond').textContent = fmtUSD(usd_total_bond);
  document.getElementById('usd_sum_stock').textContent = fmtUSD(usd_total_stock);
  document.getElementById('usd_sum_krw').textContent = fmtKRW(usd_total_krw);
  document.getElementById('usd_sum_invested_usd').textContent = fmtUSD(usd_total_invested);
  document.getElementById('usd_sum_return_amt').textContent = fmtUSD(usd_total_profit);
  document.getElementById('usd_sum_return_pct').textContent = usd_total_invested
    ? `${(usd_total_profit / usd_total_invested * 100).toFixed(1)}%`
    : '0.0%';
  if (total_krw_net > 0 && total_usd_net > 0) {
    const avg_fx = total_krw_net / total_usd_net;
    const fx_only_effect_pct = ((s.rate - avg_fx) / avg_fx) * 100;

    document.getElementById('usd_sum_fx_effect_pct').innerHTML =
      `${fx_only_effect_pct.toFixed(2)}%<br><span class="text-xs text-gray-500">(${avg_fx.toFixed(2)})</span>`;

    // 환율 고려 수익금액(KRW) = 현재 평가금액(KRW) - 원금(KRW)
    const fx_return_amt_total = (total_investment * s.rate) - total_krw_net;
    document.getElementById('usd_sum_fx_return_amt').textContent = fmtKRW(fx_return_amt_total);

    // 환율 고려 수익률(%) = (수익금액 / 원금(KRW)) × 100
    const fx_return_pct_total = (fx_return_amt_total / total_krw_net) * 100;
    document.getElementById('usd_sum_fx_return_pct').textContent = `${fx_return_pct_total.toFixed(1)}%`;
  } else {
    document.getElementById('usd_sum_fx_effect_pct').textContent = '-';
    document.getElementById('usd_sum_fx_return_amt').textContent = '-';
    document.getElementById('usd_sum_fx_return_pct').textContent = '-';
  }

  // --- KRW 계좌 렌더링 ---
  const krw_tbody = document.getElementById('krw_table');
  let krw_total_krw = 0, krw_total_usd = 0;
  let krw_total_cash = 0, krw_total_saving = 0, krw_total_bond = 0, krw_total_stock = 0;
  let krw_total_invested = 0, krw_total_profit = 0;

  const krw_sorted = s.krw_accounts.map((acc, idx) => {
    return {
      ...acc,
      networth_krw: num(s.krw_networths[idx]),
      networth_usd: num(s.krw_networths[idx]) / s.rate
    };
  }).sort((a, b) => {
    // 1) account_type 우선순위 비교
    if (order[a.account_type] !== order[b.account_type]) {
      return order[a.account_type] - order[b.account_type];
    }
    // 2) 같은 카테고리라면 networth_krw 내림차순
    return b.networth_krw - a.networth_krw;
  });
  krw_tbody.innerHTML = krw_sorted.map(acc => {
    const invested = num(acc.breakdown?.invested);
    const profit = num(acc.breakdown?.profit);
    const return_pct = invested ? (profit / invested * 100).toFixed(1) : '0.0';

    krw_total_krw += acc.networth_krw;
    krw_total_usd += acc.networth_usd;
    krw_total_cash += num(acc.breakdown?.cash);
    krw_total_saving += num(acc.breakdown?.saving);
    krw_total_bond += num(acc.breakdown?.bond);
    krw_total_stock += num(acc.breakdown?.stock);
    krw_total_invested += invested;
    krw_total_profit += profit;

    let borderClass = '';
    switch (acc.account_type) {
      case 'Checking':
        borderClass = '';
        break;
      case 'Saving':
        borderClass = 'border-l-4 border-yellow-400';
        break;
      case 'Stock':
        borderClass = 'border-l-4 border-blue-400';
        break;
    }
    return `
      <tr class="border-t">
        <td class="p-2 ${borderClass}">${acc.bank_name}</td>
        <td class="p-2">${acc.account_name}</td>
        <td class="p-2 text-right border-r-2">${fmtKRW(acc.networth_krw)}</td>

        <td class="p-2 text-right bg-blue-50">${fmtKRW(num(acc.breakdown?.cash))}</td>
        <td class="p-2 text-right bg-blue-50">${fmtKRW(num(acc.breakdown?.saving))}</td>
        <td class="p-2 text-right bg-blue-50">${fmtKRW(num(acc.breakdown?.bond))}</td>
        <td class="p-2 text-right bg-blue-50 border-r-2">${fmtKRW(num(acc.breakdown?.stock))}</td>

        <td class="p-2 text-right border-r-2">${fmtUSD(acc.networth_usd)}</td>

        <td class="p-2 text-right bg-yellow-50">${fmtKRW(invested)}</td>
        <td class="p-2 text-right bg-yellow-50">${fmtKRW(profit)}</td>
        <td class="p-2 text-right bg-yellow-50 border-r-2">${return_pct}%</td>
      </tr>`;
  }).join('');
  document.getElementById('krw_sum_krw').textContent = fmtKRW(krw_total_krw);
  document.getElementById('krw_sum_cash').textContent = fmtKRW(krw_total_cash);
  document.getElementById('krw_sum_saving').textContent = fmtKRW(krw_total_saving);
  document.getElementById('krw_sum_bond').textContent = fmtKRW(krw_total_bond);
  document.getElementById('krw_sum_stock').textContent = fmtKRW(krw_total_stock);
  document.getElementById('krw_sum_usd').textContent = fmtUSD(krw_total_usd);
  document.getElementById('krw_sum_invested_krw').textContent = fmtKRW(krw_total_invested); // ✅ 추가
  document.getElementById('krw_sum_return_amt').textContent = fmtKRW(krw_total_profit);
  document.getElementById('krw_sum_return_pct').textContent = krw_total_invested
    ? `${(krw_total_profit / krw_total_invested * 100).toFixed(1)}%`
    : '0.0%';

  // --- 자산 카테고리 파이차트 ---
  const categoryLabels = ["현금", "적금", "채권", "High-risk stock"];
  const categoryData = s.type_breakdown.slice(0, 4);

  const ctxCategory = document.getElementById('categoryPie').getContext('2d');
  new Chart(ctxCategory, {
    type: 'doughnut',
    data: {
      labels: categoryLabels,
      datasets: [{
        data: categoryData,
        backgroundColor: [
          '#93c5fd', // 현금
          '#3b82f6', // 적금
          '#2563eb', // 채권
          '#eab308'  // High-risk
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 16, weight: 'bold' },
            color: '#333'
          }
        },
        datalabels: {
          color: '#000',
          font: { size: 14, weight: 'bold' },
          formatter: (value, context) => {
            const dataset = context.chart.data.datasets[0].data;
            const total = dataset.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1) + '%';

            const usdText = `$${value.toLocaleString('en-US', { maximumFractionDigits: 0 })} (${percentage})`;
            const krwValue = value * s.rate;
            const krwText = `₩${krwValue.toLocaleString('ko-KR', { maximumFractionDigits: 0 })}`;

            return `${usdText}\n${krwText}`;
          }
        }
      },
      cutout: '35%' // 도넛 안쪽 구멍 크기
    },
    plugins: [ChartDataLabels]
  });
}
async function sync() {
  const s = await getJSON('/api/download_data');
}
document.getElementById('dataSyncButton').addEventListener('click', async () => {
  await sync();  // Call sync function when button is clicked
});
// load().catch(e => console.error(e));
  </script>
{% endblock %}
